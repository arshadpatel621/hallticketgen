<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification Fix - EduConnect</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fix-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 16px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        .status-success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status-error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .status-warning { background: #fef3cd; color: #92400e; border: 1px solid #f59e0b; }
        .status-info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">
                <i class="fas fa-envelope-open-text text-blue-600 mr-3"></i>
                Email Verification Fix Tool
            </h1>
            <p class="text-gray-600">
                Troubleshoot and fix email verification issues for EduConnect
            </p>
        </div>

        <!-- Email Troubleshooting -->
        <div class="fix-card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">
                <i class="fas fa-search text-green-600 mr-2"></i>Email Troubleshooting
            </h2>
            
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Email Address:</label>
                    <input type="email" id="troubleshootEmail" value="arshadpatel431@gmail.com" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Provider:</label>
                    <select id="emailProvider" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="gmail">Gmail</option>
                        <option value="yahoo">Yahoo</option>
                        <option value="outlook">Outlook/Hotmail</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <div class="space-y-3">
                <button onclick="checkEmailDelivery()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors w-full">
                    <i class="fas fa-magnifying-glass mr-2"></i>Diagnose Email Issues
                </button>
                <button onclick="resendVerificationEmail()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors w-full">
                    <i class="fas fa-paper-plane mr-2"></i>Resend Verification Email
                </button>
                <button onclick="testAlternativeEmail()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors w-full">
                    <i class="fas fa-envelope mr-2"></i>Test with Alternative Email
                </button>
            </div>

            <div id="troubleshootResult" class="mt-4"></div>
        </div>

        <!-- Manual Verification (For Testing) -->
        <div class="fix-card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">
                <i class="fas fa-key text-orange-600 mr-2"></i>Manual Verification (Testing Only)
            </h2>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <span class="text-yellow-800 font-medium">For Testing Purposes Only</span>
                </div>
                <p class="text-yellow-700 text-sm mt-1">
                    This bypasses email verification for immediate testing. Use only during development.
                </p>
            </div>

            <div class="space-y-3">
                <button onclick="enableTestMode()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors w-full">
                    <i class="fas fa-flask mr-2"></i>Enable Test Mode (Bypass Verification)
                </button>
                <button onclick="manuallyVerifyUser()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors w-full">
                    <i class="fas fa-user-check mr-2"></i>Manually Verify Current User
                </button>
            </div>

            <div id="manualVerificationResult" class="mt-4"></div>
        </div>

        <!-- Email Provider Guidelines -->
        <div class="fix-card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>Common Email Issues & Solutions
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Gmail Issues:</h3>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-600">
                        <li>Check Spam/Junk folder</li>
                        <li>Check Promotions tab</li>
                        <li>Check Social tab</li>
                        <li>Look for "no-reply@supabase" emails</li>
                        <li>May take 2-5 minutes to arrive</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">General Solutions:</h3>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-600">
                        <li>Wait 5-10 minutes for delivery</li>
                        <li>Check all email folders/tabs</li>
                        <li>Try a different email address</li>
                        <li>Use Gmail for best delivery</li>
                        <li>Contact your email provider</li>
                    </ul>
                </div>
            </div>

            <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">Quick Check Steps:</h4>
                <ol class="list-decimal list-inside space-y-1 text-sm text-blue-700">
                    <li>Open Gmail â†’ Check "All Mail" folder</li>
                    <li>Search for "verification" or "supabase"</li>
                    <li>Check if email is in Spam folder</li>
                    <li>Try registering with a different Gmail address</li>
                </ol>
            </div>
        </div>

        <!-- Login with Unverified Account -->
        <div class="fix-card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">
                <i class="fas fa-sign-in-alt text-indigo-600 mr-2"></i>Login Options
            </h2>
            
            <div class="space-y-3">
                <button onclick="tryLoginUnverified()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors w-full">
                    <i class="fas fa-unlock mr-2"></i>Try Login (Unverified Account)
                </button>
                <button onclick="openMainWebsite()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors w-full">
                    <i class="fas fa-home mr-2"></i>Go to Main Website
                </button>
            </div>
            
            <div id="loginResult" class="mt-4"></div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://rhvvqpiazcnsmknsowrx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJodnZxcGlhemNuc21rbnNvd3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NTUwMDAsImV4cCI6MjA3MzQzMTAwMH0.tVVwDY42PuYVlMlgixMC4mbQ11_CMVKCTKjsVRW2YeA';
        
        let supabaseClient = null;
        
        try {
            const { createClient } = supabase;
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized successfully');
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const statusClass = `status-${type}`;
            const iconMap = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            
            element.innerHTML = `
                <div class="p-4 rounded-lg ${statusClass} mt-4">
                    <i class="fas ${iconMap[type]} mr-2"></i>${message}
                </div>
            `;
        }

        async function checkEmailDelivery() {
            const email = document.getElementById('troubleshootEmail').value;
            const provider = document.getElementById('emailProvider').value;
            
            showResult('troubleshootResult', 'Checking email delivery status...', 'info');
            
            if (!email) {
                showResult('troubleshootResult', 'Please enter your email address.', 'error');
                return;
            }

            let diagnosis = `<div class="space-y-2">`;
            diagnosis += `<div><strong>Email:</strong> ${email}</div>`;
            diagnosis += `<div><strong>Provider:</strong> ${provider}</div>`;
            
            // Provider-specific guidance
            switch(provider) {
                case 'gmail':
                    diagnosis += `
                        <div class="mt-3">
                            <strong>Gmail Troubleshooting:</strong>
                            <ul class="list-disc list-inside mt-1 text-sm space-y-1">
                                <li>Check your <strong>Spam/Junk</strong> folder first</li>
                                <li>Look in the <strong>Promotions</strong> tab</li>
                                <li>Search for emails from <strong>"no-reply@supabase.com"</strong></li>
                                <li>Gmail delivery usually takes 1-3 minutes</li>
                            </ul>
                        </div>
                    `;
                    break;
                case 'yahoo':
                    diagnosis += `
                        <div class="mt-3">
                            <strong>Yahoo Troubleshooting:</strong>
                            <ul class="list-disc list-inside mt-1 text-sm space-y-1">
                                <li>Check your <strong>Bulk Mail</strong> folder</li>
                                <li>Yahoo may delay emails by 5-10 minutes</li>
                                <li>Consider using Gmail for better delivery</li>
                            </ul>
                        </div>
                    `;
                    break;
                case 'outlook':
                    diagnosis += `
                        <div class="mt-3">
                            <strong>Outlook/Hotmail Troubleshooting:</strong>
                            <ul class="list-disc list-inside mt-1 text-sm space-y-1">
                                <li>Check your <strong>Junk Email</strong> folder</li>
                                <li>Outlook sometimes blocks Supabase emails</li>
                                <li>Try using Gmail instead</li>
                            </ul>
                        </div>
                    `;
                    break;
            }
            
            diagnosis += `</div>`;
            
            showResult('troubleshootResult', diagnosis, 'info');
        }

        async function resendVerificationEmail() {
            const email = document.getElementById('troubleshootEmail').value;
            
            if (!email) {
                showResult('troubleshootResult', 'Please enter your email address first.', 'error');
                return;
            }

            showResult('troubleshootResult', 'Attempting to resend verification email...', 'info');
            
            try {
                const { data, error } = await supabaseClient.auth.resend({
                    type: 'signup',
                    email: email
                });

                if (error) {
                    showResult('troubleshootResult', `Failed to resend email: ${error.message}`, 'error');
                } else {
                    showResult('troubleshootResult', `âœ… Verification email resent to ${email}! Please check your inbox and spam folder.`, 'success');
                }
            } catch (error) {
                showResult('troubleshootResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testAlternativeEmail() {
            const currentEmail = document.getElementById('troubleshootEmail').value;
            const altEmail = prompt(`Current email: ${currentEmail}\n\nEnter an alternative Gmail address to test:`);
            
            if (!altEmail) return;
            
            showResult('troubleshootResult', `Testing registration with ${altEmail}...`, 'info');
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: altEmail,
                    password: 'test123456',
                    options: {
                        data: {
                            name: 'Test User',
                            role: 'teacher',
                            institution: 'Test Institution'
                        }
                    }
                });

                if (error) {
                    showResult('troubleshootResult', `Test registration failed: ${error.message}`, 'error');
                } else {
                    showResult('troubleshootResult', `âœ… Test registration sent to ${altEmail}! Check that inbox for verification email.`, 'success');
                }
            } catch (error) {
                showResult('troubleshootResult', `Test failed: ${error.message}`, 'error');
            }
        }

        async function enableTestMode() {
            showResult('manualVerificationResult', 'Enabling test mode...', 'info');
            
            // Set test mode flags
            localStorage.setItem('emailVerificationBypass', 'true');
            localStorage.setItem('testMode', 'true');
            
            showResult('manualVerificationResult', 'âœ… Test mode enabled! Email verification will be bypassed for new logins.', 'success');
        }

        async function manuallyVerifyUser() {
            const email = document.getElementById('troubleshootEmail').value;
            
            if (!email) {
                showResult('manualVerificationResult', 'Please enter the email address first.', 'error');
                return;
            }

            showResult('manualVerificationResult', 'Creating verified test session...', 'info');
            
            // Create a manual verified session
            const testUser = {
                id: 'manual_' + Date.now(),
                email: email,
                name: email.split('@')[0],
                role: 'teacher',
                institution: 'Test Institution',
                email_verified: true
            };
            
            // Store in localStorage for immediate access
            localStorage.setItem('authToken', `manual_verified_${Date.now()}`);
            localStorage.setItem('userData', JSON.stringify(testUser));
            localStorage.setItem('manualVerification', 'true');
            
            showResult('manualVerificationResult', `âœ… Manual verification complete! You can now access EduConnect with ${email}`, 'success');
            
            setTimeout(() => {
                if (confirm('Open EduConnect main application?')) {
                    window.open('index.html', '_blank');
                }
            }, 2000);
        }

        async function tryLoginUnverified() {
            const email = document.getElementById('troubleshootEmail').value;
            const password = prompt('Enter the password you used during registration:');
            
            if (!email || !password) {
                showResult('loginResult', 'Please provide both email and password.', 'error');
                return;
            }

            showResult('loginResult', 'Attempting login with unverified account...', 'info');
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    if (error.message.includes('Email not confirmed')) {
                        showResult('loginResult', 'âš  Account exists but email not verified. Try the manual verification option above.', 'warning');
                    } else {
                        showResult('loginResult', `Login failed: ${error.message}`, 'error');
                    }
                } else {
                    showResult('loginResult', 'âœ… Login successful! You can now access EduConnect.', 'success');
                    
                    // Store session
                    localStorage.setItem('authToken', data.session.access_token);
                    localStorage.setItem('userData', JSON.stringify({
                        id: data.user.id,
                        name: data.user.user_metadata?.name || email.split('@')[0],
                        email: data.user.email,
                        role: data.user.user_metadata?.role || 'teacher',
                        institution: data.user.user_metadata?.institution || 'Unknown'
                    }));
                    
                    setTimeout(() => {
                        if (confirm('Open EduConnect main application?')) {
                            window.open('index.html', '_blank');
                        }
                    }, 2000);
                }
            } catch (error) {
                showResult('loginResult', `Error: ${error.message}`, 'error');
            }
        }

        function openMainWebsite() {
            window.open('index.html', '_blank');
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            const savedEmail = localStorage.getItem('lastRegistrationEmail') || 'arshadpatel431@gmail.com';
            document.getElementById('troubleshootEmail').value = savedEmail;
        });
    </script>
</body>
</html>